## Linux内核 V0.11 学习笔记（一）

>- 时间：2017-06-14 23:28
>- 地点：深圳 南山
>- 作者：周博文

### 内核源代码目录结构(/boot/目录)说明

**linux-0.11/boot/**
>bootsect.s
>head.s
>setup.s

boot目录包含上述三个 .s 后缀的汇编语言程序源文件，目录里面的程序在编译内核时最先被编译，三个源文件程序的主要功能是当计算机通电时，引导操作系统内核，将内核代码加载到内存中，并执行一些进入**“32位保护运行方式”**之前的初始化工作。

#### 32位保护运行方式
- CPU的运行方式有常见的三种：**实模式、保护模式、虚拟8086模式**

- **实模式**：CPU在复位或者通电启动的时候是以实模式工作的。

>- 实模式下内存的寻址方式与8086相同，8086包含**16位数据总线**和**20位地址总线**，所以它的直接寻址空间为2^20 = 1MB，范围是00000H至FFFFFH，用其中的16位地址总线，可以访问2^16 = 64KB的输入输出端口。
>- 由于8086CPU内部只有16位的寄存器(数据总线也是16位)，无法全部保存每个存储单元的20位地址信息（地址总线20位），为了正确的访问存储器，8086采取了**分段结构**，讲1MB的内存空间划分为若干个逻辑段，在每个逻辑段中使用16位段基址和16位偏移地址进行寻址，段寄存器用来存放各段的段基址。利用BIU的地址加法器计算并形成CPU所要访问的存储单元地址（20位）或I/O端口地址（16位）。

#### 存储器分段
>- **存储地址**：指的是存储器中存储单元的编号，为了方便查找每个存储单元存储的内容，计算机对存储器的每一个单元都进行了编号，这个编号就是这个单元的地址，地址一般采用十六进制数来表示。例如8086有1MB的存储器容量，那么它的存储器地址可以表示为 00000H ~ FFFFFH。其中H表示十六进制数。
>- **大端和小端**：我们可以打个比方，就好比是吃鸡蛋是从大头开始吃还是从小头开始吃一样，存储地址的编号也是如此。
>**大端**：数字的低位放在高地址上面，高位放在底地址上面。
>**小端**：与之相反，低位放在低地址上面，高位在高地址上。
>**例子如下**：
>
>**小端模式**：16bit宽的数0x1234在CPU内存中是如下存储(假设开始地址位0x4000)
>| 内存地址 | 0x4000 | 0x4001 |
>|:------------|----------:|---------:|
>| 存放内容 | 0x34     | 0x12     |
>**大端模式**：存储如下
>| 内存地址 | 0x4000 | 0x4001 |
>|:------------|----------:|---------:|
>| 存放内容 | 0x12     | 0x34     |
>- **存储器分段**：上文已经说了，8086CPU地址线是20根，而数据线只有16根，在传输地址时一次只能传输16位的有效地址，只能有效访问2^16=64K字节的地址空间。为了实现寻址1M就引入了分段的概念。
>所谓分段，就是把1M的地址空间划分为若干个逻辑段，每个逻辑段都必须满足下面的条件：
>1.逻辑段的开始地址必须是16的倍数，段寄存器长是16位。
>2.逻辑段最大长度位64K，因为指针寄存器长位16位。
>- **地址计算**：由于有了分段的概念，每一个64K是一个段，这个段的**段地址**就是这一块开始的地址，这个地址是可变的，因而可以实现1M空间的寻址。
>实际物理地址（20位）= 段地址*10H + 段内偏移地址
>例如：之所以是乘以10H是因为，段地址取得是实际物理地址的高四位，由段寄存器提供，因为它只能存储四位（16位的寄存器），10H就是16，相乘可以理解为**进一位**然后加上偏移地址，所以最后的到的就是实际物理地址。
>- **段寄存器**：一个8086程序可以同时使用四个段。
>**代码段寄存器**：CS，存储程序代码。
>**数据段寄存器**：DS，存储程序中用到的数据。
>**堆栈段寄存器**：SS，用作堆栈。
>**附加段寄存器**：ES，也用来存储数据。
>上述四个寄存器都是16位的，通常计算机在取指令的时候，CPU会自动引用代码段寄存器CS，再加上IP（指令指针）所给的16位段内偏移，由BIU内的地址加法器自动算出指令的实际物理地址。
>当涉及堆栈操作的时候，这时候的物理地址由堆栈寄存器SS，加上SP（堆栈指针）所提供的段内偏移计算得出。
>通常如果程序大小不超过64K，使用一个64K字节的段就可以，如果程序数据区长度大于64K，那就需要在两个或者多个数据段中存取数据，此时取值只需要改变数据段寄存器里面的值就可以。
>|访问存储器涉及的方式|正常使用的段寄存器|可选用的段寄存器|段内偏移|
>|:---------------------------|:-------------------------|:---------------------|:-----------|
>|取指令                          |CS                               |无                         |IP             |
>|堆栈操作                      |SS                               |无                         |SP             |
>|一般数据（下列除外）|DS                               |CS、ES、SS         |有效地址  |
>|源数据串                       |DS                               |CS、ES、SS        |SI             |
>|目的数据串                  |ES                               |无                          |DI             |
>|BP作为指针寄存器使用|SS                               |CS、ES、DS         |有效地址   |



